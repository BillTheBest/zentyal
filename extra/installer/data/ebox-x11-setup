#!/bin/sh

USER_NAME=`getent passwd uid 1000 | cut -d: -f1`
DIR=/home/$USER_NAME

sed -i "s/#auto_login.*/auto_login\tyes/" /etc/slim.conf
sed -i "s/#default_user.*/default_user\t$USER_NAME/" /etc/slim.conf
sed -i "s/.*current_theme.*/current_theme\tslim-zentyal-simple/" /etc/slim.conf

cp /var/tmp/ebox/ebox-xsession $DIR/.xsession
chmod +x $DIR/.xsession
chown $USER_NAME:$USER_NAME $DIR/.xsession

echo "mode: off" > $DIR/.xscreensaver
echo "selected: -1" >> $DIR/.xscreensaver
chown $USER_NAME:$USER_NAME $DIR/.xscreensaver

mkdir $DIR/.mozilla
cp -r /var/tmp/ebox/ebox-firefox-profile $DIR/.mozilla/firefox
chown -R $USER_NAME:$USER_NAME $DIR/.mozilla
chmod -R +w $DIR/.mozilla

PROFILE=$DIR/.mozilla/firefox/ebox.default
CERT=/var/lib/ebox/conf/ssl/ssl.cert
ID='eBox Server'
certutil -d $PROFILE -A -n "$ID" -t ',,' -i $CERT
/var/tmp/ebox/ebox-cert-override > $PROFILE/cert_override.txt

mv /var/tmp/ebox/slim-zentyal-simple /usr/share/slim/themes/
# Copy icon and wallpaper
mv /var/tmp/ebox/lxde-zentyal/*.png /usr/share/pixmaps/

# lxde setup
DESKTOP=`su $USER_NAME -c "xdg-user-dir DESKTOP"`
mkdir -p $DESKTOP
mv /var/tmp/ebox/lxde-zentyal/Desktop/zentyal.desktop /usr/share/applications/
mv /var/tmp/ebox/lxde-zentyal/zentyal-logout.desktop /usr/share/applications/
mv /var/tmp/ebox/lxde-zentyal/zentyal-logout /usr/bin/
ln -sf /usr/share/applications/zentyal.desktop $DESKTOP/zentyal.desktop
mv /var/tmp/ebox/lxde-zentyal/Desktop/* $DESKTOP/
PANELS_DIR=$DIR/.config/lxpanel/LXDE/panels
mkdir -p $PANELS_DIR
mv /var/tmp/ebox/lxde-zentyal/bottom $PANELS_DIR/
sed -i "s/DESKTOP_PATH/$DESKTOP/" $PANELS_DIR/bottom
PCMANFM_DIR=$DIR/.config/pcmanfm
mkdir -p $PCMANFM_DIR
mv /var/tmp/ebox/lxde-zentyal/main.lxde $PCMANFM_DIR/
chown -R $USER_NAME:$USER_NAME $DESKTOP
chown -R $USER_NAME:$USER_NAME $DIR/.config

mv /var/tmp/ebox/second-boot.sh /etc/rc.local

/etc/init.d/slim restart

exit 0
