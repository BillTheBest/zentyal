#!/bin/bash

# eBox installation script to execute after reboot but before login

# Define some quick variables
export LOG=/tmp/ebox-installer.log
SOURCES_LIST=/etc/apt/sources.list
PPA_URL="http://ppa.launchpad.net/ebox/1.5/ubuntu"
EBOX_SOURCES="deb $PPA_URL lucid main"
PKG_DIR=/var/tmp/ebox-packages
LOCAL_SOURCES="deb file:$PKG_DIR ./"

create_repository() {
    cd $PKG_DIR
    apt-ftparchive packages . | gzip > Packages.gz 2>>$LOG
    cd - > /dev/null
    # Update the package database with only the local repository
    # just in case we are installing without internet connection
    mv ${SOURCES_LIST} /var/tmp
    echo ${LOCAL_SOURCES} > ${SOURCES_LIST}
    apt-get update >> $LOG 2>&1
    # Restore the original sources.list
    mv /var/tmp/sources.list ${SOURCES_LIST}
    # Move packages to the cache
    mv $PKG_DIR/*.deb /var/cache/apt/archives/
}

update_if_network() {
    # Import PPA key to avoid warning
    apt-key add /var/tmp/ebox-ppa.asc >> $LOG 2>&1
    # Check if we can connect to the PPA url
    if $(wget -T 10 -t 1 $PPA_URL >> $LOG 2>&1); then
        echo "Updating package database from the network..." >> $LOG
        apt-get update >> $LOG 2>&1
    else
        echo "Warning: Can't connect to $PPA_URL. Updates won't be installed." >> $LOG
    fi
}

gen_locales() {
    # load LANG variable with default locale
    . /etc/default/locale

    # Append eBox support languages to generate to current supported
    # locales
    LOCALES_FILE=/var/lib/locales/supported.d/local
    TMP=/tmp/local.tmp
    cat /var/tmp/locale.gen $LOCALES_FILE > $TMP
    sort $TMP | uniq > $LOCALES_FILE
    rm -f $TMP

    # Regenerate locales to update the new messages from eBox
    /usr/sbin/locale-gen

    /usr/share/ebox/ebox-set-locale $LANG > /dev/null 2>&1
}

create_repository # Set up local package repository

echo ${LOCAL_SOURCES} >> ${SOURCES_LIST} # add local sources
echo ${EBOX_SOURCES} >> ${SOURCES_LIST} # add ppa sources

update_if_network # apt-get update if we are connected to the internet

gen_locales

/var/tmp/ebox-x11-setup

rm -f /var/tmp/locale.gen
rm -fr /var/tmp/ebox-*

exit 0
