#!/usr/bin/python
# Copyright (C) 2011 eBox Technologies S.L.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the Lesser GNU General Public License as
# published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# Lesser GNU General Public License for more details.
#
# You should have received a copy of the Lesser GNU General Public
# License along with This program; if not, write to the
#	Free Software Foundation, Inc.,
#	59 Temple Place, Suite 330,
#	Boston, MA  02111-1307
#	USA

import sys
sys.path += ['../adsync', '../export']

import gtk, tarfile
import dhcp, dns
from zentyal_pwdsync_common import *

# FIXME: change this with a link to the new Migration Tool doc
ADSYNC_URL = "http://trac.zentyal.org/Documentation/EBoxActiveDirectorySync"

class MigrationApp(object):
    def on_adsyncEnabled_clicked(self, widget, data=None):
        set_adsync_status(self.adsyncEnabled.get_active())

    def on_mainWindow_destroy(self, widget, data=None):
        gtk.main_quit()

    def on_okButton_clicked(self, widget, data=None):
        set_passwdhk_defaults()
        set_passwdhk_confkey("host", self.host.get_text())
        set_passwdhk_confkey("port", self.port.get_text())
        set_passwdhk_confkey("secret", self.secret.get_text())
        gtk.main_quit()

    def on_exportButton_clicked(self, widget, data=None):
        # TODO: error dialog if no checkboxes are selected
        path = ""
        if self.fileSaveDialog.run() == gtk.RESPONSE_OK:
            path = self.fileSaveDialog.get_filename()
            self.fileSaveDialog.destroy()
        if not path:
            return
        tar = tarfile.open(path + ".tar.gz", "w:gz")
        if self.exportDHCP.get_active():
            dhcp.export("dhcp.yaml")
            tar.add("dhcp.yaml")
        if self.exportDNS.get_active():
            dns.export("dns.yaml")
            tar.add("dns.yaml")
        if self.exportPDC.get_active():
            pass # FIXME
        tar.close()

    def on_aboutButton_clicked(self, widget, data=None):
        self.about.show()

    def on_aboutDialog_response(self, widget, data=None):
        self.about.hide()

    def __init__(self):
        builder = gtk.Builder()
        builder.add_from_file("migration.xml")
        builder.connect_signals(self)
        self.window = builder.get_object("mainWindow")
        self.about = builder.get_object("aboutDialog")
        self.fileSaveDialog = builder.get_object("fileSaveDialog")
        self.adsyncEnabled = builder.get_object("adsyncEnabled")
        self.adsyncEnabled.set_active(get_adsync_status())
        self.host = builder.get_object("hostEntry")
        self.host.set_text(get_passwdhk_confkey("host"))
        self.port = builder.get_object("portEntry")
        self.port.set_text(get_passwdhk_confkey("port"))
        self.secret = builder.get_object("secretEntry")
        self.secret.set_text(get_passwdhk_confkey("secret"))
        self.exportDHCP = builder.get_object("exportDHCP")
        self.exportDNS = builder.get_object("exportDNS")
        self.exportPDC = builder.get_object("exportPDC")
        self.adsyncHelp = builder.get_object("adsyncHelpLabel")
        self.adsyncHelp.set_markup('Here you can configure the settings for the AD Password Synchronizer. More info at <a href="' + ADSYNC_URL + '">' + ADSYNC_URL + '</a>')

if __name__ == "__main__":
    app = MigrationApp()
    app.window.set_title('Zentyal Migration Tool')
    app.window.show()
    gtk.main()
